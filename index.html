<!-- Made by Evan Dunne | Laois GAA -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Intensity Index Tracker</title>

<!-- Chart.js + html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root { color-scheme: light dark; }

/* -------- Base -------- */
body {
  font-family: system-ui, sans-serif;
  margin: 0;
  padding: 0;
  transition: background .3s, color .3s;
}
@media (prefers-color-scheme: dark) {
  body { background: linear-gradient(180deg,#111,#222); color:#fff; }
  .stat-label { color: #ccc; }
}
@media (prefers-color-scheme: light) {
  body { background: linear-gradient(180deg,#f0f0f0,#fff); color:#111; }
  .stat-label { color: #333; }
}

/* -------- Layout -------- */
.app {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  padding: 1.25rem 1rem;
  align-items: center;
}
.left {
  width: 95%;
  max-width: 480px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.right {
  width: 95%;
  max-width: 900px;
}
@media (min-width:1024px) {
  .app {
    flex-direction: row;
    align-items: flex-start;
    justify-content: center;
    gap: 2rem;
    padding: 2rem;
  }
  .left { max-width: 440px; position: sticky; top: 16px; }
  .right { flex: 1; max-width: none; min-width: 0; }
}

/* -------- Headings -------- */
h1 { font-size: 2rem; margin: .25rem 0; text-align: center; }
#indexValue { font-size: 3.6rem; font-weight: 800; margin: .6rem 0 1rem; text-align: center; }

/* -------- Buttons -------- */
.stack > * { width: 100%; box-sizing: border-box; }
.btn {
  display: block;
  width: 100%;
  margin: .65rem 0;
  padding: 1.9rem;
  font-size: 1.5rem;
  border: none;
  border-radius: 1.2rem;
  color: #fff;
  background: #1e88e5;
  box-shadow: 0 4px 10px rgba(0,0,0,.3);
  transition: background .15s, transform .1s, filter .15s;
}
#tacklePlus,#tackleMinus { background: #444; }
#possessionBtn.active { background: #d32f2f; }
.btn:active { transform: scale(.96); filter: brightness(1.2); }

/* -------- Stats -------- */
.stats {
  width: 100%;
  display: flex;
  gap: .9rem;
  margin-top: 1.1rem;
}
.stat {
  flex: 1;
  background: #3333;
  border-radius: 1rem;
  box-shadow: 0 3px 8px rgba(0,0,0,.2);
  padding: .9rem 1rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
.stat-label { font-size: 1rem; margin-bottom: .25rem; text-align: center; }
.stat-value { font-size: 2.8rem; font-weight: 800; line-height: 1; text-align: center; }

/* -------- Graph -------- */
#graphWrapper { width: 95%; max-width: 480px; margin: 1.5rem auto 0; }
canvas { width: 100%; height: 260px !important; border-radius: 10px; }
@media (min-width:1024px) {
  #graphWrapper { width: 100%; max-width: none; margin-top: 2cm; }
  .right canvas { height: calc(100vh - 160px) !important; }
}

/* -------- Report + Reset -------- */
#reportBtn {
  width: 100%;
  margin: 1rem 0 .6rem;
  padding: 1.4rem;
  font-size: 1.3rem;
  border: none;
  border-radius: 1rem;
  color: #fff;
  background: #2e7d32;
  box-shadow: 0 3px 10px rgba(0,0,0,.3);
}

.slider {
  width: 100%;
  height: 72px;
  background: #333;
  border-radius: 50px;
  overflow: hidden;
  position: relative;
  user-select: none;
  touch-action: none;
  box-shadow: 0 3px 8px rgba(0,0,0,.25);
}
.slider-text {
  position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  color: #bbb; font-size: 1.2rem; pointer-events: none;
}
.slider-handle {
  position: absolute; top: 6px; left: 6px;
  width: 60px; height: 60px; border-radius: 50%;
  background: #1e88e5; transition: background .3s; z-index: 2;
}
.slider.complete { background: #2e7d32; }
.slider.complete .slider-handle { background: #43a047; }
.slider.complete .slider-text { color: #fff; }

footer { margin: .8rem 0 0; font-size: .9rem; opacity: .8; text-align: center; }

/* Flash animation */
.flash { animation: flash .25s ease-out; }
@keyframes flash { 0%{filter:brightness(2);transform:scale(1.05)}100%{filter:brightness(1);transform:scale(1)} }
</style>
</head>
<body>

<div class="app">
  <aside class="left">
    <h1>Intensity Index Tracker</h1>
    <div id="indexValue">0.00</div>

    <div class="stack">
      <button id="possessionBtn" class="btn">Start Opposition Possession</button>
      <button id="tacklePlus" class="btn">+1 Tackle</button>
      <button id="tackleMinus" class="btn">−1 Tackle</button>
    </div>

    <div class="stats">
      <div class="stat">
        <div class="stat-label">Tackles</div>
        <div class="stat-value" id="tackleCount">0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Opp Poss Time</div>
        <div class="stat-value" id="timeDisplay">00:00</div>
      </div>
    </div>

    <button id="reportBtn">Generate Report</button>

    <div class="slider" id="resetSlider">
      <div class="slider-text" id="sliderText">Slide to Reset</div>
      <div class="slider-handle" id="sliderHandle"></div>
    </div>

    <p id="shortcutInfo" style="font-size:.9rem;text-align:center;opacity:.7;margin-top:1rem;">
      <strong>Space</strong> = Start/Stop Poss |
      <strong>T</strong> = +1 Tackle |
      <strong>R</strong> = −1 Tackle
    </p>

    <footer>Evan Dunne | Laois GAA</footer>
  </aside>

  <main class="right">
    <div id="graphWrapper">
      <canvas id="intensityChart"></canvas>
    </div>
  </main>
</div>

<script>
/* ------------------------ STATE ------------------------ */
let tackles=0, oppSecondsAccum=0, oppStartMs=null, possessionActive=false;
const elIndex=document.getElementById("indexValue"),
      elTackles=document.getElementById("tackleCount"),
      elTimeDisplay=document.getElementById("timeDisplay"),
      btnPos=document.getElementById("possessionBtn");

function formatTime(seconds){
  const s=Math.max(0,Math.floor(seconds));
  const m=Math.floor(s/60), ss=s%60;
  return `${m}:${String(ss).padStart(2,'0')}`;
}
function getCurrentOppSeconds(){
  return possessionActive ? oppSecondsAccum+(Date.now()-oppStartMs)/1000 : oppSecondsAccum;
}
function intensityAt(sec){
  const mins=Math.max(0,sec)/60;
  return mins>0?tackles/mins:0;
}

/* ------------------------ CHART ------------------------ */
const ctx=document.getElementById('intensityChart').getContext('2d');
const dataset={
  label:'Intensity Index',
  data:[],
  borderColor:'#1e88e5',
  backgroundColor:'rgba(30,136,229,0.15)',
  borderWidth:2,
  fill:true,
  tension:0.35,
  spanGaps:false,
  pointRadius:c=>{
    const n=c.dataset.data.length;
    if(n<=20)return 5;
    if(n<=60)return(c.dataIndex%3===0?4:0);
    if(n<=120)return(c.dataIndex%6===0?3:0);
    return 0;
  },
  pointHoverRadius:6,
  pointBackgroundColor:'#1e88e5',
  pointBorderColor:'#fff'
};
const chart=new Chart(ctx,{
  type:'line',
  data:{datasets:[dataset]},
  options:{
    responsive:true,
    maintainAspectRatio:false,
    animation:{duration:600,easing:'easeOutQuart'},
    scales:{
      x:{
        type:'linear',
        min:0,
        suggestedMax:60,
        ticks:{autoSkip:false,callback:v=>formatTime(v)},
        title:{display:true,text:'Opp Poss Time (MM:SS)'},
      },
      y:{beginAtZero:true,title:{display:true,text:'Intensity Index'}}
    },
    plugins:{legend:{display:false}}
  }
});

/* ------------------------ LOGGING ------------------------ */
const LOG_INTERVAL=5;
let nextLogAt=0,timer=null;

function tickStepFor(total){
  if(total<120)return 5;
  if(total<300)return 15;
  if(total<600)return 30;
  return 60;
}
function roundUp(v,step){return Math.ceil(v/step)*step;}
function updateXAxis(final=false){
  const total=getCurrentOppSeconds();
  const step=tickStepFor(total);
  chart.options.scales.x.ticks.stepSize=step;
  chart.options.scales.x.max=final?Math.round(total):Math.max(step,roundUp(total,step));
}

function pushSample(sec){
  dataset.data.push({x:sec,y:intensityAt(sec)});
}

function startLogging(){
  if(timer) return;
  timer=setInterval(()=>{
    if(!possessionActive)return;
    const now=getCurrentOppSeconds();
    while(now>=nextLogAt+LOG_INTERVAL-1e-6){
      nextLogAt+=LOG_INTERVAL;
      pushSample(nextLogAt);
    }
    render();
    updateXAxis(false);
    chart.update();
  },250);
}
function stopLogging(){clearInterval(timer);timer=null;}

/* ------------------------ UI ------------------------ */
function render(){
  elTackles.textContent=tackles;
  const sec=getCurrentOppSeconds();
  elTimeDisplay.textContent=formatTime(sec);
  const mins=sec/60;
  elIndex.textContent=mins>0?(tackles/mins).toFixed(2):"0.00";
}

/* ------------------------ CONTROL ------------------------ */
function togglePossession(){
  if(!possessionActive){
    // START
    oppStartMs=Date.now();
    possessionActive=true;
    btnPos.textContent="Stop Opposition Possession";
    btnPos.classList.add("active");
    dataset.data=[]; // fresh start
    pushSample(0);   // log immediately at 0
    nextLogAt=0;
    updateXAxis(false);
    chart.update();
    startLogging();
  } else {
    // STOP
    oppSecondsAccum+=(Date.now()-oppStartMs)/1000;
    possessionActive=false; oppStartMs=null;
    btnPos.textContent="Start Opposition Possession";
    btnPos.classList.remove("active");
    const finalSec=Math.round(oppSecondsAccum);
    const lastX=dataset.data.length?dataset.data[dataset.data.length-1].x:-1;
    if(finalSec>lastX)pushSample(finalSec);
    else if(finalSec<lastX)dataset.data[dataset.data.length-1]={x:finalSec,y:intensityAt(finalSec)};
    stopLogging();
    render();
    updateXAxis(true);
    chart.update();
  }
}

document.getElementById("tacklePlus").onclick=e=>{
  tackles++;render();e.target.classList.add('flash');
  setTimeout(()=>e.target.classList.remove('flash'),200);
};
document.getElementById("tackleMinus").onclick=e=>{
  if(tackles>0)tackles--;render();e.target.classList.add('flash');
  setTimeout(()=>e.target.classList.remove('flash'),200);
};
btnPos.onclick=togglePossession;

/* ------------------------ RESET SLIDER ------------------------ */
let startX=0,currentX=0,dragging=false;
const slider=document.getElementById("resetSlider"),
      handle=document.getElementById("sliderHandle"),
      sliderText=document.getElementById("sliderText");

function resetAll(){
  tackles=0;oppSecondsAccum=0;oppStartMs=null;possessionActive=false;nextLogAt=0;
  dataset.data.length=0;chart.options.scales.x.max=60;chart.update();
  btnPos.textContent="Start Opposition Possession";btnPos.classList.remove("active");
  render();
  slider.classList.add("complete");sliderText.textContent="Game Reset";
  handle.style.left=(slider.offsetWidth-handle.offsetWidth-6)+"px";
  setTimeout(()=>{slider.classList.remove("complete");
    handle.style.left="6px";sliderText.textContent="Slide to Reset";},1500);
}
function startDrag(e){dragging=true;startX=(e.touches?e.touches[0].clientX:e.clientX);}
function onDrag(e){
  if(!dragging)return;
  const clientX=(e.touches?e.touches[0].clientX:e.clientX);
  const dx=clientX-startX;const max=slider.offsetWidth-handle.offsetWidth-6;
  currentX=Math.min(Math.max(6,dx+6),max);handle.style.left=currentX+"px";
}
function endDrag(){
  if(!dragging)return;dragging=false;
  const max=slider.offsetWidth-handle.offsetWidth-10;
  if(currentX>=max-4)resetAll();else handle.style.left="6px";
}
handle.addEventListener("mousedown",startDrag);
handle.addEventListener("touchstart",startDrag,{passive:true});
window.addEventListener("mousemove",onDrag);
window.addEventListener("touchmove",onDrag,{passive:false});
window.addEventListener("mouseup",endDrag);
window.addEventListener("touchend",endDrag);

/* ------------------------ MOBILE GRAPH REPOSITION ------------------------ */
document.addEventListener("DOMContentLoaded",()=>{
  const left=document.querySelector(".left");
  const right=document.querySelector(".right");
  const graph=document.getElementById("graphWrapper");
  const reportBtn=document.getElementById("reportBtn");
  function repositionGraph(){
    const isMobile=window.innerWidth<1024;
    const parent=graph.parentElement;
    if(isMobile&&parent!==left)left.insertBefore(graph,reportBtn);
    else if(!isMobile&&parent!==right)right.appendChild(graph);
  }
  repositionGraph();window.addEventListener("resize",repositionGraph);
});

/* ------------------------ SHORTCUTS ------------------------ */
document.addEventListener("keydown",e=>{
  if(["INPUT","TEXTAREA"].includes(document.activeElement.tagName))return;
  switch(e.key.toLowerCase()){
    case " ":
    case "spacebar":e.preventDefault();btnPos.click();break;
    case "t":e.preventDefault();document.getElementById("tacklePlus").click();break;
    case "r":e.preventDefault();document.getElementById("tackleMinus").click();break;
  }
});

render();
</script>
</body>
</html>

