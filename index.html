<!-- Made by Evan Dunne Laois GAA -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Intensity Index Tracker</title>

<!-- Chart.js + html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root { color-scheme: light dark; }

/* -------- Base -------- */
body{
  font-family: system-ui, sans-serif;
  margin:0; padding:0;
  transition:background .3s,color .3s;
}
@media (prefers-color-scheme: dark){
  body{background:linear-gradient(180deg,#111,#222);color:#fff;}
  .stat-label{color:#ccc;}
}
@media (prefers-color-scheme: light){
  body{background:linear-gradient(180deg,#f0f0f0,#fff);color:#111;}
  .stat-label{color:#333;}
}

/* -------- App layout -------- */
.app{
  display:flex;
  flex-direction:column;
  gap:1.5rem;
  padding:1.25rem 1rem;
  align-items:center;
}
.left{
  width:95%;
  max-width:480px;
  display:flex;
  flex-direction:column;
  align-items:center;
}
.right{
  width:95%;
  max-width:900px;
}

/* Desktop split */
@media (min-width:1024px){
  .app{
    flex-direction:row;
    align-items:flex-start;
    justify-content:center;
    gap:2rem;
    padding:2rem;
  }
  .left{
    max-width:440px;
    position:sticky; top:16px;
  }
  .right{
    flex:1; max-width:none; min-width:0;
  }
}

/* -------- Heading / index -------- */
h1{font-size:2rem;margin:.25rem 0 .25rem;text-align:center;}
#indexValue{font-size:3.6rem;font-weight:800;margin:.6rem 0 1rem;text-align:center;}

/* -------- Shortcut info -------- */
#shortcutInfo {
  font-size: 0.9rem;
  text-align: center;
  opacity: 0.75;
  margin: 1rem 0 0.5rem;
}
@media (prefers-color-scheme: dark) {
  #shortcutInfo { color: #ccc; }
}
@media (prefers-color-scheme: light) {
  #shortcutInfo { color: #444; }
}
@media (max-width:1023px){
  #shortcutInfo { display: none; }
}

/* -------- Buttons -------- */
.stack > *{width:100%; box-sizing:border-box;}
.stack{width:100%;}
.btn{
  display:block;
  width:100%;
  margin:.65rem 0;
  padding:1.9rem;
  font-size:1.5rem;
  border:none;border-radius:1.2rem;
  color:#fff;background:#1e88e5;
  box-shadow:0 4px 10px rgba(0,0,0,.3);
  transition:background .15s,transform .1s,filter .15s;
}
#tacklePlus,#tackleMinus{background:#444;}
#possessionBtn.active{background:#d32f2f;}
.btn:active{transform:scale(.96);filter:brightness(1.2);}

/* -------- Stats row -------- */
.stats{
  width:100%;
  display:flex;
  gap:.9rem;
  margin-top:1.1rem;
}
.stat{
  flex:1;
  background:#3333;
  border-radius:1rem;
  box-shadow:0 3px 8px rgba(0,0,0,.2);
  padding:.9rem 1rem;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}
.stat-label{font-size:1rem;margin-bottom:.25rem;text-align:center;}
.stat-value{font-size:2.8rem;font-weight:800;line-height:1;text-align:center;}

/* -------- Graph -------- */
#graphWrapper {
  width: 95%;
  max-width: 480px;
  margin: 1.5rem auto 0;
}
canvas {
  width: 100%;
  height: 260px !important;
  border-radius: 10px;
}

@media (min-width:1024px) {
  #graphWrapper {
    width: 100%;
    max-width: none;
    margin-top: 2cm;
  }
  .right canvas {
    height: calc(100vh - 160px) !important;
  }
}

@media (max-width:1023px){
  #graphWrapper {
    margin-top: 1.2rem;
    margin-bottom: 1.2rem;
  }
}

/* -------- Report + Reset -------- */
#reportBtn{
  width:100%;
  margin:1rem 0 .6rem;
  padding:1.4rem;
  font-size:1.3rem;
  border:none;border-radius:1rem;
  color:#fff;background:#2e7d32;
  box-shadow:0 3px 10px rgba(0,0,0,.3);
}

.slider{
  width:100%;
  height:72px;
  background:#333;border-radius:50px;
  overflow:hidden;position:relative;
  user-select:none;touch-action:none;
  box-shadow:0 3px 8px rgba(0,0,0,.25);
}
.slider-text{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  color:#bbb; font-size:1.2rem; pointer-events:none;
  white-space:nowrap; text-align:center;
}
.slider-handle{
  position:absolute; top:6px; left:6px;
  width:60px;height:60px;border-radius:50%;
  background:#1e88e5; transition:background .3s; z-index:2;
}
.slider.complete{background:#2e7d32;}
.slider.complete .slider-handle{background:#43a047;}
.slider.complete .slider-text{color:#fff;}

footer{margin:.8rem 0 0; font-size:.9rem; opacity:.8; text-align:center;}

/* -------- Flash animation -------- */
.flash{animation:flash .25s ease-out;}
@keyframes flash{0%{filter:brightness(2);transform:scale(1.05)}100%{filter:brightness(1);transform:scale(1)}}
</style>
</head>
<body>

<div class="app">
  <!-- LEFT COLUMN -->
  <aside class="left">
    <h1>Intensity Index Tracker</h1>
    <div id="indexValue">0.00</div>

    <div class="stack">
      <button id="possessionBtn" class="btn">Start Opposition Possession</button>
      <button id="tacklePlus"  class="btn">+1 Tackle</button>
      <button id="tackleMinus" class="btn">−1 Tackle</button>
    </div>

    <div class="stats">
      <div class="stat">
        <div class="stat-label">Tackles</div>
        <div class="stat-value" id="tackleCount">0</div>
      </div>
      <div class="stat">
        <div class="stat-label">Opp Poss Time</div>
        <div class="stat-value" id="timeDisplay">00:00</div>
      </div>
    </div>

    <button id="reportBtn">Generate Report</button>

    <div class="slider" id="resetSlider">
      <div class="slider-text" id="sliderText">Slide to Reset</div>
      <div class="slider-handle" id="sliderHandle"></div>
    </div>

    <p id="shortcutInfo">
      <strong>Space</strong> = Start/Stop Poss |
      <strong>T</strong> = +1 Tackle |
      <strong>R</strong> = −1 Tackle
    </p>

    <footer>Evan Dunne | Laois GAA</footer>
  </aside>

  <!-- RIGHT COLUMN -->
  <main class="right">
    <div id="graphWrapper">
      <canvas id="intensityChart"></canvas>
    </div>
  </main>
</div>

<script>
/* ------------------------ STATE ------------------------ */
let tackles=0, oppSecondsAccum=0, oppStartMs=null, possessionActive=false;

const elIndex=document.getElementById("indexValue"),
      elTackles=document.getElementById("tackleCount"),
      elTimeDisplay=document.getElementById("timeDisplay"),
      btnPos=document.getElementById("possessionBtn");

function formatTime(seconds){
  const s = Math.max(0, Math.floor(seconds));
  const m=Math.floor(s/60), ss=s%60;
  return `${String(m)}:${String(ss).padStart(2,'0')}`;
}
function getCurrentOppSeconds(){
  return possessionActive ? oppSecondsAccum + (Date.now()-oppStartMs)/1000 : oppSecondsAccum;
}
function intensityAtSeconds(sec) {
  const mins = Math.max(0, sec) / 60;
  return mins > 0 ? (tackles / mins) : 0;
}
function getLiveIntensity(){
  const mins = getCurrentOppSeconds()/60;
  return mins>0 ? tackles/mins : 0;
}

/* ------------------------ CHART ------------------------ */
/* We use XY points with a linear x-axis measured in seconds */
const ctx=document.getElementById('intensityChart').getContext('2d');

const dataset = {
  label:'Intensity Index',
  data:[],                   // [{x: seconds, y: intensity}]
  borderColor:'#1e88e5',
  backgroundColor:'rgba(30,136,229,0.15)',
  borderWidth:2,
  fill:true,
  tension:0.3,
  spanGaps:false,
  pointRadius:(c)=>{
    const n=c.dataset.data.length;
    if(n<=20) return 5;
    if(n<=60) return (c.dataIndex%3===0?4:0);
    if(n<=120) return (c.dataIndex%6===0?3:0);
    return 0;
  },
  pointHoverRadius:6,
  pointBackgroundColor:'#1e88e5',
  pointBorderColor:'#fff',
  parsing: true,             // Chart reads x/y from objects
};

const chart = new Chart(ctx,{
  type:'line',
  data:{ datasets:[dataset] },
  options:{
    responsive:true, maintainAspectRatio:false,
    animation:false,
    scales:{
      x:{
        type:'linear',
        min:0,
        suggestedMax:60, // start with 1 minute, will update dynamically
        ticks:{
          autoSkip:false,
          callback:(value)=>formatTime(value)
        },
        title:{display:true, text:'Opp Poss Time (MM:SS)'},
        grace: 0
      },
      y:{
        beginAtZero:true,
        title:{display:true, text:'Intensity Index'}
      }
    },
    plugins:{ legend:{display:false} }
  }
});

/* ---- Dynamic tick step based on total seconds ---- */
function tickStepFor(totalSecs){
  if(totalSecs < 120) return 5;        // <2 min → 5s
  if(totalSecs < 300) return 15;       // 2–5 min → 15s
  if(totalSecs < 600) return 30;       // 5–10 min → 30s
  return 60;                           // ≥10 min → 60s
}
function roundUpTo(value, step){
  return Math.ceil(value/step)*step;
}
function updateXAxisLimits(final=false){
  const total = getCurrentOppSeconds();
  const step = tickStepFor(total);
  chart.options.scales.x.ticks.stepSize = step;

  if (final){
    // After stop: exact domain end (no padding), so the line reaches the end
    const exact = Math.max(0, Math.round(total));
    chart.options.scales.x.max = exact;
  } else {
    // While running: keep a clean rounded window that always contains the line
    const maxRounded = Math.max(step, roundUpTo(total, step));
    chart.options.scales.x.max = maxRounded;
  }
}

/* ------------------------ LOGGING ------------------------ */
/* Log strictly every 5 seconds, starting at 0. Also force a final exact sample at stop. */
const LOG_EVERY = 5; // seconds
let nextLogAt = 0;
let samplerInterval = null;

function pushSample(sec){
  dataset.data.push({ x: sec, y: intensityAtSeconds(sec) });
}

function startLogging(){
  if (samplerInterval) return;

  // Ensure a 0s sample exists on start
  if (dataset.data.length === 0) {
    nextLogAt = 0;
    pushSample(0); // y = 0 at t=0
  }

  samplerInterval = setInterval(()=>{
    if(!possessionActive) return;

    const nowSecs = getCurrentOppSeconds();

    // Log each 5s boundary we’ve crossed; handles timer jitter
    while (nowSecs >= nextLogAt + LOG_EVERY - 1e-6) {
      nextLogAt += LOG_EVERY;
      pushSample(nextLogAt);
    }

    // Update UI + axis during run
    render();
    updateXAxisLimits(false);
    chart.update('none');
  }, 250);
}

function stopLogging(){
  if (samplerInterval) {
    clearInterval(samplerInterval);
    samplerInterval = null;
  }
}

/* ------------------------ UI RENDER ------------------------ */
function render(){
  elTackles.textContent = String(tackles);
  const seconds = getCurrentOppSeconds();
  elTimeDisplay.textContent = formatTime(seconds);
  elIndex.textContent = getLiveIntensity().toFixed(2);
}

/* ------------------------ CONTROLS ------------------------ */
function togglePossession(){
  if(!possessionActive){
    // START
    oppStartMs = Date.now();
    possessionActive = true;
    btnPos.textContent = "Stop Opposition Possession";
    btnPos.classList.add("active");

    // If fresh start, align logging to 0 and kick off
    if (dataset.data.length === 0) {
      nextLogAt = 0;
      pushSample(0);
    } else {
      // Resume: keep nextLogAt aligned to last logged boundary
      const lastX = dataset.data[dataset.data.length-1].x;
      nextLogAt = lastX;
    }

    startLogging();
  } else {
    // STOP
    oppSecondsAccum += (Date.now() - oppStartMs)/1000;
    possessionActive = false;
    oppStartMs = null;
    btnPos.textContent = "Start Opposition Possession";
    btnPos.classList.remove("active");

    // Force a final exact-end sample so the line hits the right edge
    const finalSecs = Math.max(0, Math.round(oppSecondsAccum));
    const lastX = dataset.data.length ? dataset.data[dataset.data.length-1].x : -1;

    if (finalSecs > lastX) {
      pushSample(finalSecs);
    } else if (finalSecs < lastX) {
      // If we overshot a touch (shouldn't happen, but guard): replace last point
      dataset.data[dataset.data.length-1] = { x: finalSecs, y: intensityAtSeconds(finalSecs) };
    }

    stopLogging();
    render();
    updateXAxisLimits(true);
    chart.update();
  }
}

document.getElementById("tacklePlus").onclick = (e)=>{
  tackles++;
  render();
  e.target.classList.add('flash');
  setTimeout(()=>e.target.classList.remove('flash'),200);
};
document.getElementById("tackleMinus").onclick = (e)=>{
  if(tackles>0) tackles--;
  render();
  e.target.classList.add('flash');
  setTimeout(()=>e.target.classList.remove('flash'),200);
};
btnPos.onclick = togglePossession;

/* ------------------------ REPORT (PNG) ------------------------ */
document.getElementById("reportBtn").addEventListener("click", async () => {
  const reportCanvas=document.createElement("canvas");
  reportCanvas.width=1000;
  reportCanvas.height=900;
  const c2=reportCanvas.getContext("2d");

  // Background
  c2.fillStyle="#fff";
  c2.fillRect(0,0,reportCanvas.width,reportCanvas.height);

  // Header
  c2.fillStyle="#000";
  c2.font="28px Arial";
  c2.fillText("Laois Intensity Index Report",40,50);

  // Timestamp
  const now=new Date();
  const ts=now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})+" – "+now.toLocaleDateString();
  c2.font="16px Arial";
  c2.fillText(ts,40,80);

  // Stats
  c2.font="22px Arial";
  c2.fillText("Intensity Index Rating: "+getLiveIntensity().toFixed(2),40,120);
  c2.fillText("Tackles: "+tackles,40,155);
  c2.fillText("Opposition Possession Time: "+formatTime(getCurrentOppSeconds()),40,190);

  // Chart snapshot
  const chartCanvas=document.getElementById("intensityChart");
  const img=new Image();
  img.src=chartCanvas.toDataURL("image/png");
  await new Promise((resolve)=>{img.onload=resolve; img.onerror=resolve;});
  c2.drawImage(img,40,240,920,600);

  // Download
  const a=document.createElement("a");
  a.download="Laois_Intensity_Report.png";
  a.href=reportCanvas.toDataURL("image/png");
  a.click();
});

/* ------------------------ RESET SLIDER ------------------------ */
let startX=0,currentX=0,dragging=false;
const slider=document.getElementById("resetSlider"),
      handle=document.getElementById("sliderHandle"),
      sliderText=document.getElementById("sliderText");

function resetAll(){
  tackles=0; oppSecondsAccum=0; oppStartMs=null; possessionActive=false;
  nextLogAt=0;
  dataset.data.length = 0;
  chart.options.scales.x.min = 0;
  chart.options.scales.x.max = 60;
  chart.update();

  btnPos.textContent="Start Opposition Possession"; btnPos.classList.remove("active");
  render();
  slider.classList.add("complete"); sliderText.textContent="Game Reset";
  handle.style.left=(slider.offsetWidth - handle.offsetWidth - 6)+"px";
  setTimeout(()=>{
    slider.classList.remove("complete");
    handle.style.left="6px";
    sliderText.textContent="Slide to Reset";
  },1500);
}
function startDrag(e){ dragging=true; startX=(e.touches?e.touches[0].clientX:e.clientX); }
function onDrag(e){
  if(!dragging) return;
  const clientX=(e.touches?e.touches[0].clientX:e.clientX);
  const dx=clientX-startX; const max=slider.offsetWidth - handle.offsetWidth - 6;
  currentX=Math.min(Math.max(6,dx+6),max); handle.style.left=currentX+"px";
}
function endDrag(){
  if(!dragging) return; dragging=false;
  const max=slider.offsetWidth - handle.offsetWidth - 10;
  if(currentX>=max-4) resetAll(); else handle.style.left="6px";
}
handle.addEventListener("mousedown",startDrag);
handle.addEventListener("touchstart",startDrag,{passive:true});
window.addEventListener("mousemove",onDrag);
window.addEventListener("touchmove",onDrag,{passive:false});
window.addEventListener("mouseup",endDrag);
window.addEventListener("touchend",endDrag);

/* ------------------------ MOBILE GRAPH REPOSITIONING ------------------------ */
document.addEventListener("DOMContentLoaded", () => {
  const left=document.querySelector(".left");
  const right=document.querySelector(".right");
  const graph=document.getElementById("graphWrapper");
  const reportBtn=document.getElementById("reportBtn");

  function repositionGraph(){
    const isMobile=window.innerWidth<1024;
    const graphParent=graph.parentElement;
    if(isMobile && graphParent!==left){
      left.insertBefore(graph,reportBtn);
    }else if(!isMobile && graphParent!==right){
      right.appendChild(graph);
    }
  }
  repositionGraph();
  window.addEventListener("resize",repositionGraph);
});

/* ------------------------ KEYBOARD SHORTCUTS ------------------------ */
document.addEventListener("keydown",(e)=>{
  if(["INPUT","TEXTAREA"].includes(document.activeElement.tagName))return;
  switch(e.key.toLowerCase()){
    case " ":
    case "spacebar":
      e.preventDefault();
      btnPos.click();
      break;
    case "t":
      e.preventDefault();
      document.getElementById("tacklePlus").click();
      break;
    case "r":
      e.preventDefault();
      document.getElementById("tackleMinus").click();
      break;
  }
});

/* Initial render */
render();
</script>
</body>
</html>
